<dom-module id="ir-gallery-slider">
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400,700' rel='stylesheet' type='text/css'>

	<template>
		<style>
			:host > *
			{
				box-sizing : border-box;
			}
		
			.scroller {
				@apply(--layout-horizontal);
			}
			.image-container,.slide-frame, .slide {
				@apply(--layout-vertical);
				@apply(--layout-center);
				@apply(--layout-around-justified);
				position : relative;
				
				/*width : 600px;
				height : 600px;*/
			}

			rv-iscroll {
				/*width : 600px;
				height : 600px;*/
			}
			
			.slide {
				margin-left : 2px;
				margin-right : 6px;
			}
			
			.slide-frame-border:not([no-border]) {
				border : 6px solid #56646f;
				border-radius : 9px;
				background : white;
				margin-left : 3px;
			}
			
			.slide-frame ,.caption {
				@apply(--layout-vertical);
				@apply(--layout-center);
				@apply(--layout-around-justified);
			}
			
			.slide-frame .image-container
			{
				height : calc(100% - 3em);
				width : 100%;
			}

			.slide-frame .image-container img {
				max-width : 100%;
				max-height : 100%;
			}
			
			ir-image-sizer {
				cursor : pointer;			
			}
			
			.image-container {
				padding : 9px;
			}
			
			.slide-frame[no-captions] .caption-wrapper {
				display : none;
			}
			
			.slide-frame .caption {
				max-width : 100%;
				height : 3em;
				text-align : center;
				
				font-family : 'Open Sans', sans-serif;
				font-size : 11px;
				line-height : 1.2em;

				margin : 0 auto;
				padding : 3px;
			}

			.caption-wrapper {
				background-color : #f2f2f2;
				width : calc(100% - 1px);
			}
						
		</style>
		
		<rv-iscroll manual id="rvs" scroll-x is-ready="{{ isReady }}" iscroll-snap=".slide" iscroll-mousewheel="true" style$="width : calc([[ width ]]); height : calc([[ height ]])">
			<div class="scroller" style$="height : calc([[ height ]])">
				<template is="dom-repeat" items="[[ images ]]">
					<div class="slide" style$="[[ slideSizingStyle ]]">
						<div class$="slide-frame [[ _slideFrameBorderClass ]]" no-captions$="[[noCaptions]]" no-border$="[[noBorder]]" data="[[ item ]]" on-click="_slideClick">
							<div class="image-container" data="[[ item ]]" on-click="_imgClick">
								<ir-image-sizer
									id="__ir-gallery-slider-[[ index ]]"
									
									width="[[ _imageContainerWidth(item,width,height) ]]" 
									height="[[ _imageContainerHeight(item,width,height) ]]" 
									
									src="[[ item.src ]]" 
								></ir-image-sizer>
							</div>
							<div hidden="[[ !item.caption ]]" class="caption-wrapper" style$="max-width : calc([[ _imageContainerWidth(item,width,height) ]])">
								<div class="caption">
									[[ item.caption ]]
								</div>
							</div>
						</div>
					</div>
				</template>
				</div>
			</div>
		</rv-iscroll>
	</template>
<script>
(function() {
	Polymer({
		is : "ir-gallery-slider",

		properties : {
			images : { type : Array, value : function() { return [] }, notify : true, observer : "refresh" },
			demo : { type : Boolean, value : true, notify : true },
			currentPage : { type : Number, value : 0, notify : true, observer  : "_pageChangedFromBinding" },
			currentTarget : { type : Object, notify : true, computed  : "_currentTarget(currentPage,isReady)" },
			
			isAttached : { type : Boolean, value : false, notify : true },
			
			isReady : { type : Boolean, value : false, notify : true, observer : "_scrollerReadyChanged" },
			
			noCaptions : { type : Boolean, value : false, notify : true },
			noBorder : { type : Boolean, value : false, notify : true },
			
			_slideFrameBorderClass : { type : String, value : "slide-frame-border", notify : true, computed : "_slideFrameBorder(noBorder)" },
			
			slideSizingStyle : { type : String, value : "", notify : true },
			imageSizingStyle : { type : String, value : "", notify : true },
			imageContainerSizingStyle : { type : String, value : "", notify : true },
			
			width : { type : String, notify : true },
			height : { type : String, notify : true },
			slidesPerView : { type : Number, value : 1, notify : true }
		},
		
		observers : [
			'_updateSize(isAttached,noCaptions,noBorder,slidesPerView,width,height,images.*)'
		],
		
		refresh : function() {
			if(!this.$.rvs)
				this.async(this.refresh, 500); // try again later
			
			this.debounce("refresh", function() {
				this.updateStyles();
				this.$.rvs.refresh();
			}, 1000);
		},

		_imgClick : function(e) {
			this.fire('slider-image-click', { data : e.currentTarget.data, target : Polymer.dom(e.currentTarget).children[0] });
		},

		_slideClick : function(e) {
			this.fire('slider-slide-click', { data : e.currentTarget.data, target : Polymer.dom(e.currentTarget).querySelector('ir-image-sizer') });
		},

		_slideFrameBorder : function() {
			return this.noBorder ? "no-frame-border" : "slide-frame-border";
		},

		_updateSize : function() {
			this.set("slideSizingStyle", "height : calc(" + this.height + "); width : calc(" + this._imageContainerWidth(true) + ")");
			this.refresh();
		},

		// returns a calc() expression without the calc()
		_imageContainerHeight(item) {
			var res = 	"(" + 
							this.height + 
							(!this.noCaptions && item.caption ? " - 2.7em" : "") +
							(this.noBorder ? "" : " - 30px") +
						")"; // caption and border
		
			return res;
		},
		
		// returns a calc() expression without the calc()
		_imageContainerWidth : function(includeBorder) {
			var res =  	"(" + 
							(this.slidesPerView <= 1 ? this.width : this.width + " / " + this.slidesPerView) + 
							(this.noBorder || includeBorder === true ? " - 6px" : " - 30px") + 
						")";
			return res;
		},
		
		_scrollerReadyChanged : function() {
			if(this.scrollerReady)
				this.$.rvs.iscroll.on('scrollEnd', this._pageChangedFromScroller.bind(this));
		},
		
		_currentTarget : function() {
			var sf;
			if(!this.$.rvs)
				return;
			sf = Polymer.dom(this.root).querySelectorAll(".slide-frame");
			if(!sf.length)
				return 
				
			return sf[this.currentPage];
		},

		_pageChangedFromBinding : function(n, o)
		{
			if(this.disabled) 
				return;
			
			if(!this.$.rvs.iscroll || !this.$.rvs.iscroll.pages || (!n && n != 0))
				return;

			this.$.rvs.iscroll.goToPage(this.currentPage, 0);
		},
		
		_pageChangedFromScroller : function(n, o)
		{
			if(!this.$.rvs.iscroll)
				return;
			
			this.set("currentPage", this.$.rvs.iscroll.currentPage.pageX);
		},
	
		goToPage : function(n) {
			this.$.rvs.iscroll.goToPage(n, 0)
		},
	
		attached : function() {
			this.set('attached', true)		
		},
	})
	
	var Units = {
		getUnits : function(v) { return v.replace(/\d/g, ''); },
		multiply : function(v, factor) { return (parseFloat(v) * factor) + Units.getUnits(v) }, 
		divide : function(v, factor) { return (parseFloat(v) / factor) + Units.getUnits(v) } 
	}
})()
</script>
</dom-module>
