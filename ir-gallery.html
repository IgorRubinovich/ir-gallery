<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-spinner/paper-spinner.html">
<link rel="import" href="../rv-iscroll/rv-iscroll.html">
<link rel="import" href="./ir-gallery-panel.html">
<link rel="import" href="./ir-gallery-slider.html">
<link rel="import" href="./ir-image-sizer.html">


<!--
	Structure (in jade-ish):
	
		ir-gallery
		----------
			ir-gallery-panel(inline)
			
			paper-dialog(fullScreen)
				ir-gallery-panel(fullScreen)
				
			paper-dialog(zoom)
				img // active image
				
		
		ir-gallery-panel
		----------------
			ir-gallery-slider(main view)
			buttons
			ir-gallery-slider(thumbnails view)
			
			
		ir-gallery-slider
		-------------------
			rv-iscroll // providing an instance of iScroll
				template(is="dom-for")
					ir-image-sizer // same as img/iron-image, but fits the src image into the given dimentions while keeping smaller images at their original size

-->

<dom-module id="ir-gallery">
	<style>
		:host {
			box-sizing : border-box;
			x-iron-icon-fill-color : red;
		}
		icon-button {
			background-color : green;
		}
		paper-dialog > *
		{
			padding : 0;
		}
		#fullScreenDialog {
			width : 100vw;
			height : 100vh;
			margin : 0;
			background : rgba(0,0,0,.3);
		}
		
		#zoomDialog
		{
			width : 97vw;
			height : 97vh;
			overflow : auto;
			margin : 0;
			xmargin : 10px 0 0 -5px;
			background : lightgrey;
		}
		
		#zoomWrapper
		{
			text-align : center;
			margin : 0;
			padding : 3px;
			min-height : 96vh;
			@apply(--layout-vertical);
			@apply(--layout-center);
			@apply(--layout-around-justified);
		}

		#zoomDialog img {
			max-width : 100%;
			height : auto;
		}
		
		#zoom-out-container {
			position : fixed;
			right : 3vw;
			top : 3vh;
			z-index : 10000;
		}
	</style>
	<template>
		<template is="dom-if" if="[[ keepInlineFormat ]]">
			<content></content>
		</template>
		
		<template is="dom-if" if="[[ !keepInlineFormat ]]">
			<ir-gallery-panel 
				id="inlineGallery" 
				current-page="{{ currentPage }}"
				on-slide-click="openDialog"
				no-border
				images="[[ images ]]"
				width="[[ width ]]"
				height="[[ height ]]"
				thumbnails-hidden="[[ inlineThumbnailsHidden ]]"
			></ir-gallery-panel>
		</template>
		
		<!--template is="dom-if" if="[[ fullScreen ]]"-->
			<paper-dialog 
				x-entry-animation="scale-up-animation" 
              exit-animation="fade-out-animation" id="fullScreenDialog" on-iron-overlay-closed="_fullScreenClosed" on-iron-overlay-opened="_fullScreenOpened">
				<ir-gallery-panel
					id="dialogGallery"
					current-page="{{ currentPage }}"
					selected-slide="{{ currentDialogTarget }}"
					x-on-slide-click="zoom"
					images="[[ images ]]"
					width="100vw"
					height="100vh"
					keep-captions-space
					thumbnails-hidden="[[ fullScreenThumbnailsHidden ]]"
				>
				</ir-gallery-panel>
				<div id="close-container" style="background-color : rgba(255,255,255,.5); border-radius : 24px; position : absolute; right : 0; bottom : 0;">
					<paper-icon-button icon="close" on-tap="closeFullScreen"></paper-icon-button>
				</div>
				<div id="zoom-container" style="background-color : rgba(255,255,255,.5); border-radius : 24px; position : absolute; right : 0; top : 0;">
					<paper-icon-button icon="fullscreen" on-tap="zoom"></paper-icon-button>
				</div>
			</paper-dialog>
		<!--/template-->
		<paper-dialog id="zoomDialog" on-iron-overlay-closed="_unzoomed" opened="{{ isZooming }}">
			<div id="zoomWrapper" class="icon-button">
				<img src="[[ zoomedImageSrc ]]">
			</div>
		</paper-dialog>
		<div hidden$="[[ !isZooming ]]" id="zoom-out-container" class="icon-button">
			<paper-icon-button icon="fullscreen-exit" on-tap="unzoom"></paper-icon-button>
		</div>
	</template>

	<script>
	
	
	(function() {
		"use sctrict";
		Polymer({
			is : "ir-gallery",
			properties : {
				currentPage : { type : Number, value : 0, notify : true },
				currentDialogTarget : { type : Object, notify : true, observer : "_pageChanged" },
				
				images : { type : Array, value : function() { return [] }, notify : true },
				imagesDomPath : { type : String, notify : true },
				
				demo : { type : Boolean, value : true, notify : true },

				sizingStyle : { type : String, value : "", notify : true },
				width : { type : String, value : "400px", notify : true },
				height : { type : String, value : "400px", notify : true },

				fullScreenThumbnailsHidden : { type : Boolean, value : false },
				inlineThumbnailsHidden : { type : Boolean, value : false },
				
				/* just a convenience when using inline images that are wrapped in <a></a> as a fallback */
				clickPreventDefault : { type : Boolean, value : false },
				
				inlineThumbnailsHidden : { type : Boolean, value : false },
				
				slidesPerView : { type : Number, value : 1, notify : true },

				slidesHeight : { type : String, value : "300px", notify : true },
				thumbnailsHeight : { type : String, value : "100px", notify : true },

				isReadyToDisplay : { type : Boolean, value : false, computed : "_isReadyToDisplay(images.*,width,height)" },

				zoomedImageSrc : { type : String, value : "", notify : true },
				fullScreen : { type : Boolean, value : false },
				isZooming : { type : Boolean, value : false },
			
				keepInlineFormat : { type : Boolean, value : false }
			},
			observers : ["_updateSize(width,height,slidesPerView,images.*)"],
			
			// zoom
			zoom : function(e) {
				this.set("zoomedImageSrc", this.currentDialogTarget.data.src);
				this.$.zoomDialog.open()
				this._unbindArrowKeyListeners();
			},
			
			unzoom : function(e) {
				this.set("zoomedImageSrc", this.currentDialogTarget.data.src);
				this.$.zoomDialog.close()
				this._bindArrowKeyListeners();
			},
			
			_unzoomed : function(e) {
				this._bindArrowKeyListeners();
			},
			
			// full screen
			openDialog : function(e) {
				if((e.detail.data.img.naturalHeight <= e.detail.target.actualHeight) && (e.detail.data.img.naturalWidth <= e.detail.target.actualWidth))
					return
				
				this.set('fullScreen', true);
				
				this.async(function() {					
					this.$$("#fullScreenDialog").open();
					
					this.async(function() {
						var dg = this.$$("#dialogGallery");						
						
						dg.refresh();
						this.async(function() {
							dg.goToPage(this.currentPage);
						}, 200);
					}, 200);
					//this.$.dialogGallery.refresh();
				})
			},
			closeFullScreen : function() {
				var fsd = this.$$('#fullScreenDialog');
				fsd && fsd.close();
			},
			
			_fullScreenClosed : function() {
				document.body.style.overflow = this._bodyOverflow;
				this._unbindArrowKeyListeners();
			},
			
			_fullScreenOpened : function() {
				this._bodyOverflow = document.body.style.overflow;
				document.body.style.overflow = 'hidden';
				this._bindArrowKeyListeners();
				if(!this.currentPage)
					this.goToPage(0);
				this._pageChanged()
			},
			
			
			_configDialog : function() {
				var dg = this.$$("#dialogGallery"), cc, zc;
				
				// one time
				if(this.__dialogConfig)
					return;

				cc = this.$$('#close-container');
				zc = this.$$('#zoom-container');

				this.__dialogConfig = {
					closeButton : dg.injectIntoSlide(cc, "slide-frame"),
					zoomButton : dg.injectIntoSlide(zc, "slide-frame")
				};
				
				Polymer.dom.flush();
				
				this.__dialogConfig.closeButton.addEventListener("click", this.closeFullScreen.bind(this));
				this.__dialogConfig.zoomButton.addEventListener("click", this.zoom.bind(this));

				cc.style.visibility = 'hidden';
				zc.style.visibility = 'hidden';

			},
	
			// keyboard control
			_unbindArrowKeyListeners : function() {
				document.removeEventListener('keydown', this.__dialogConfig.listeners.keydown);
			},
			
			_bindArrowKeyListeners : function() {
				this.__dialogConfig.listeners = {
					keydown : this._keydown.bind(this)
				};
				
				document.addEventListener('keydown', this.__dialogConfig.listeners.keydown);
			},
			
			_keydown : function(e) {
				if(e.which == 37)
					this.prev();
				else
				if(e.which == 39)
					this.next();
					
			},
			
			_pageChanged : function() {
				var r;
				
				if(!this.currentDialogTarget || !this.fullScreen)
					return;
					
				r = this.currentDialogTarget.mediaItem.getBoundingClientRect();

				this.__dialogConfig.zoomButton.style.visibility = 
					this.currentDialogTarget.data.img.naturalWidth > r.width ||
					this.currentDialogTarget.data.img.naturalHeight > r.height
						? "visible" : "hidden";
						
				this.__dialogConfig.closeButton.style.visibility = 'visible';
			},
			next : function() {
				var p = this.currentPage;
				p = p >= this.images.length - 1 ? 0 : p + 1;
				this.set("currentPage", p);
			},
			prev : function() {
				var p = this.currentPage;
				p = p <= 0 ? this.images.length - 1 : p - 1;
				this.set("currentPage", p);
			},
			goToPage : function(n) {
				this.set("currentPage", n);
			},
		
			// internal services
			_isReadyToDisplay : function() {
				return this.images.length && this.width && this.height
			},
			_updateSize : function() {
				this.set("sizingStyle", "height : " + this.height + "; width : " + (this.slidesPerView <= 1 ? this.width : Units.divide(this.width, this.slidesPerView)) + ";");
				
				this.slidesHeight = Units.multiply(this.height, this.images.length > 1 ? .70 : 1);
				this.thumbnailsHeight = Units.multiply(this.height, this.images.length > 1 ? .20 : 0);
				
				this.refresh();
			},
			refresh : function() {
				this.$.scroller && this.$.scroller.refresh();
				this.$.thumbnails && this.$.thumbnails.refresh();
			},
			attached : function() {
				this._getImages();
				this._configDialog();
			},
			
			_getImagesAtDomPath : function() {
				var root, arre = /(\S+)\[(\d+)]\]/, split;
				split = this.imagesDomPath.split(".");
				root = 
					split
						.reduce(function(res, curr) {
							var arr = curr.match(arre), res;
							if(arr)
								return Polymer.dom(res)[arr[0]][arr[1]];
							else
								return Polymer.dom(res)[curr]; 
						}, this)
						
				return Polymer.dom(root)
						.querySelectorAll('img')
						.map(function(img) { return img.parentNode.tagName == 'FIGURE' ? img.parentNode : img });
			},
			
			_getImages : function() {
				var sources, idp;

				(this.imagesDomPath ? this._getImagesAtDomPath() : Polymer.dom(this).children)
					.forEach(function(el, i) {
						var imgData, fc, img = el, caption = "";

						if(el.tagName == 'FIGURE')
						{
							img = Polymer.dom(el).querySelector('img');
							fc = Polymer.dom(el).querySelector('figcaption');
							caption = fc && fc.textContent;
						}
						if(!img)
							return;
							
						imgData = {
							img : img,
							src : img.src,
							caption : caption,
							index : i
						}

						this.push("images", imgData);
						
						img.addEventListener('click', this._inlineContentClick.bind(this, imgData)); // only useful when not using the inline mode		
					}.bind(this));
			},
			
			/* Process clicks on images located outside this element's shadow dom (either when using keep-inline-format or images-dom-path) */
			_inlineContentClick : function(imgData, e) {
				this.openDialog({ detail : { data : imgData, target : imgData.img }});
				if(this.clickPreventDefault)
					e.preventDefault();
				this.goToPage(imgData.index);
			}
		});
		
		var Units = {
			getUnits : function(v) { return v.replace(/\d/g, ''); },
			multiply : function(v, factor) { return (parseFloat(v) * factor) + Units.getUnits(v) }, 
			divide : function(v, factor) { return (parseFloat(v) / factor) + Units.getUnits(v) } 
		}
	})()
	</script>
</dom-module>