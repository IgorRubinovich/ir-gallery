<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../rv-iscroll/rv-iscroll.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">
<link rel="import" href="../neon-animation/neon-animation.html">
<link rel="import" href="../iron-image/iron-image.html">

<dom-module id="ir-gallery">
  
    <template>

        <style>

        #gallery-scroller {
            width : 900px;
            height : 580px;
        }     

        .scroller-image {
            height : 580px;
        }

        #inline-scroller {
            width : 667px;
            height : 500px;
        }

        .scroller-image[inline-style] {
            height : 500px;
        }

        #inline-thumbnails {
            width : 667px;
            height : 78px;
            padding-top : 10px;
        }

        #gallery-thumbnails {
            width : 900px;
            height : 78px;
            padding-top : 10px;
        }

        .scroller-items {
            display: -webkit-box;
            display : flex;

            -webkit-flex-direction: row;
            flex-direction : row;

            align-items: center;
            text-align: center;
        }

        .inline-item {
            margin-right : 10px;
            position: relative;
        }

        .scroller-item {
            margin-right : 10px;
            position: relative;
        }

        .thumbnail-items {
            display: -webkit-box;
            display : flex;

            -webkit-flex-direction: row;
            flex-direction : row;
        }

        .thumbnail-item {
            height : 62px;
            -webkit-flex-basis: auto;
            flex-basis  : auto;
            min-width : 60px;
            margin-right : 10px;
            position: relative;
        }

        iron-image.selected {
            display: block;
            content: " ";
            border-left: 16px solid transparent;
            border-right: 16px solid transparent;
        }

        .caption {
            display: block;
            clear: left;
            text-align: center;
            font-size: 13px;
            color: #56646f;
            line-height: 1.4em;
            margin: 0 auto;
            background-color: #F2F2F2;
        }

        #navigationButtons {
            display: flex;
            justify-content: space-between;
        }

        </style>
          
        <span on-click="showGallery" hidden$="{{ !showDefaultImages }}">
            <content></content>
        </span>
        
        <paper-dialog id="onePictureDialog" on-iron-resize="resizeGallery" entry-animation="scale-up-animation" exit-animation="fade-out-animation">
          <iron-image src="{{ imgSrc }}" class="scroller-image" sizing="contain"></iron-image>
          <span class="caption">{{ imgCaption }}</span>
        </paper-dialog>

        <div id="inline-gallery" hidden$="{{ !inlineMode }}">

          <rv-iscroll id="inline-scroller" scroll-x iscroll-snap=".inline-item">
            <div class="scroller-items">
              <template id="template" is="dom-repeat" items="{{ images }}">
                <div class="inline-item">
                  <iron-image src="{{ item.image }}" inline-style$="{{ inlineMode }}" class="scroller-image" sizing="contain" on-click="showGallery"></iron-image>
                  <span class="caption">{{ item.caption }}</span>
                </div>
              </template>
            </div>
          </rv-iscroll>

          <div id="navigationButtons">
            <paper-icon-button id="iback" icon="arrow-back"></paper-icon-button>
            <paper-icon-button id="iforward" icon="arrow-forward"></paper-icon-button>
          </div>

          <rv-iscroll id="inline-thumbnails" scroll-x iscroll-snap=".thumbnail-item">
            <div class="thumbnail-items">
                <template id="template" is="dom-repeat" items="{{ images }}">
                  <div class="thumbnail-item">
                    <paper-material elevation="0">
                      <iron-image src="{{ item.image }}" style="width: 90px; height: 62px; padding: 2px 0;" data-iscroll-page$="{{ index }}" sizing="contain">
                    <paper-material>
                  </div>
                </template>
            </div>
          </rv-iscroll>

        </div>

        <paper-dialog id="gallery" on-iron-overlay-closed="destroyScroller" on-iron-resize="resizeGallery"  entry-animation="scale-up-animation" exit-animation="fade-out-animation">
          <div>

            <rv-iscroll id="gallery-scroller" scroll-x iscroll-snap=".scroller-item">
              <div class="scroller-items">
                <template id="template" is="dom-repeat" items="{{ images }}">
                  <div class="scroller-item">
                    <iron-image src="{{ item.image }}" class="scroller-image" sizing="contain"></iron-image>
                    <span class="caption">{{ item.caption }}</span>
                  </div>
                </template>
              </div>
            </rv-iscroll>
            
            <div id="navigationButtons">
              <paper-icon-button id="back" icon="arrow-back"></paper-icon-button>
              <paper-icon-button id="forward" icon="arrow-forward"></paper-icon-button>
            </div>

            <rv-iscroll id="gallery-thumbnails" scroll-x iscroll-snap=".thumbnail-item">
              <div class="thumbnail-items">
                  <template id="template" is="dom-repeat" items="{{ images }}">
                    <div class="thumbnail-item">
                      <paper-material elevation="0">
                        <iron-image src="{{ item.image }}" style="width: 90px; height: 62px; padding: 2px 0;" data-iscroll-page$="{{ index }}" sizing="contain">
                      </paper-material>
                    </div>
                  </template>
              </div>
            </rv-iscroll>  

          </div>
        </paper-dialog>
                
    </template>

    <script>
        Polymer({
            is : 'ir-gallery',

            properties : {
                images  : { type : Array, value : [] },
                imgSrc : { type : String },
                imgCaption : { type : String },
                showDefaultImages : { type : Boolean, value : false },
                onePictureMode : { type : Boolean, value : false },
                inlineMode : { type : Boolean, value : false },
                galleryMode : { type : Boolean, value : false },
                pageToSwap : { type : Number, value : 0 }    
            },


            ready : function() {
                var images = Polymer.dom(this).querySelectorAll('img'),
                    captions = Polymer.dom(this).querySelectorAll('span'),
                    arr = [];

                for(var i = 0; i < images.length; i++)
                {
                    arr[i] = { 'image' : images[i].src, 'caption' : '' };
                }

                for(var j = 0; j < captions.length; j++)
                {
                  if(captions[j].parentNode.querySelector('img'))
                    for(var k = 0; k < images.length; k++)
                      if(arr[k].image == captions[j].parentNode.querySelector('img').src)
                        arr[k].caption = captions[j].innerHTML; 
                }

                this.images = arr;

                setTimeout(function() {
                    var that = this;
                    this.$['inline-gallery'].style.width = this.$['inline-scroller'].style.width = this.$['inline-thumbnails'].style.width = this.parentNode.offsetWidth + "px";
                    var imagesToResize = this.$['inline-scroller'].getElementsByTagName('iron-image');
                        for(var i = 0; i < imagesToResize.length; i++)
                        {
                          imagesToResize[i].style.width = this.parentNode.offsetWidth + "px";
                          imagesToResize[i].style.height = document.documentElement.clientHeight / 2 + "px";
                        } 

                    window.addEventListener('resize', function(e) {
                        that.$['inline-gallery'].style.width = that.$['inline-scroller'].style.width = that.$['inline-thumbnails'].style.width = that.parentNode.offsetWidth + "px";
                        var imagesToResize = that.$['inline-scroller'].getElementsByTagName('iron-image');
                        for(var i = 0; i < imagesToResize.length; i++)
                        {
                          imagesToResize[i].style.width = that.parentNode.offsetWidth + "px";
                          imagesToResize[i].style.height = document.documentElement.clientHeight / 2 + "px";
                        } 
                    });

                    this.$['inline-scroller'].scroll.refresh();
                    this.$['inline-thumbnails'].scroll.refresh();

                }.bind(this), 200);
                
                if(this.images.length !== 0)
                {
                    if((this.images.length == 1) && !this.onePictureMode)
                    {
                      this.onePictureMode = true;
                      this.showDefaultImages = true;
                    }

                    if(this.galleryMode)
                      this.showDefaultImages = true;

                    if(!this.inlineMode && !this.galleryMode && !this.onePictureMode)
                    {
                      this.inlineMode = true;
                      this.galleryMode = true;
                    }

                    if(this.inlineMode)
                    {
                      setTimeout(function() {
                        this.setUpScroller('inline-scroller', 'inline-thumbnails', 'iback', 'iforward');
                        this.$['inline-scroller'].scroll.refresh();
                        this.$['inline-thumbnails'].scroll.refresh();
                      }.bind(this), 200)
                    }
                }      
            },

            resizeGallery : function(e) {
                if(e.currentTarget.id == 'gallery')
                {
                  this.$['gallery-scroller'].style.width = e.currentTarget._fitWidth - 128 + "px";
                  this.$['gallery-scroller'].style.height = e.currentTarget._fitHeight / 1.5 + "px";
                  this.$['gallery-thumbnails'].style.width = e.currentTarget._fitWidth - 128 + "px";

                  var imagesToResize = this.$['gallery-scroller'].getElementsByTagName('iron-image');
                  for(var i = 0; i < imagesToResize.length; i++)
                  {
                    imagesToResize[i].style.width = document.documentElement.clientWidth - 128 + "px";
                    imagesToResize[i].style.height = document.documentElement.clientHeight / 1.5 + "px";
                  } 

                  setTimeout(function() {
                      this.$['gallery-scroller'].scroll.refresh();
                      this.$['gallery-thumbnails'].scroll.refresh();
                    }.bind(this), 200)
                }
                else
                  if(e.currentTarget.id == 'onePictureDialog')
                  {
                    this.$.onePictureDialog.style.width = e.currentTarget._fitWidth + "px";
                    this.$.onePictureDialog.style.height = e.currentTarget._fitHeight + "px";
                    this.$.onePictureDialog.getElementsByTagName('iron-image')[0].style.width = e.currentTarget._fitWidth - 128 + "px";
                    this.$.onePictureDialog.getElementsByTagName('iron-image')[0].style.height = e.currentTarget._fitHeight - 128 + "px";
                  }
            },

            showGallery : function(e) {
                //this.images = Polymer.dom(this).querySelectorAll('img');

                var imagesToResize = this.$['gallery-scroller'].getElementsByTagName('iron-image');
                for(var i = 0; i < imagesToResize.length; i++)
                {
                  imagesToResize[i].style.width = document.documentElement.clientWidth - 128 + "px";
                  imagesToResize[i].style.height = document.documentElement.clientHeight / 1.5 + "px";
                }

                this.$['gallery-scroller'].style.width = document.documentElement.clientWidth - 128 + "px";
                this.$['gallery-scroller'].style.height = document.documentElement.clientHeight / 1.5 + "px";

                this.$['gallery-thumbnails'].style.width = document.documentElement.clientWidth - 128 + "px";


                var targetImg = e.target.src,
                    i, that = this;

                if(this.onePictureMode)
                {
                  this.imgSrc = targetImg;
                  if(Polymer.dom(this).querySelector('span'))
                    this.imgCaption = Polymer.dom(this).querySelector('span').innerHTML;

                  this.$.onePictureDialog.style.width = document.documentElement.clientWidth + "px";
                  this.$.onePictureDialog.style.height = document.documentElement.clientHeight + "px";
                  this.$.onePictureDialog.getElementsByTagName('iron-image')[0].style.width = document.documentElement.clientWidth - 128 + "px";
                  this.$.onePictureDialog.getElementsByTagName('iron-image')[0].style.height = document.documentElement.clientHeight - 128 + "px";

                  this.$.onePictureDialog.open();
                }
                else
                  if(this.galleryMode)
                  {
                    this.$.gallery.open();

                    this.$['inline-scroller'].scroll.destroy();
                    this.$['inline-thumbnails'].scroll.destroy();


                    this.$['gallery-scroller'].scroll._init();
                    this.$['gallery-thumbnails'].scroll._init();
                    
                    setTimeout(function () {
                        this.$["gallery-scroller"].scroll.refresh();
                        this.$["gallery-thumbnails"].scroll.refresh();
                        this.$['gallery-thumbnails'].fire('click', that.pageToSwap);
                    }.bind(this), 200); 

                    if(!this.scrollerSetupDone)
                      {
                        this.scrollerSetupDone = true;
                        this.setUpScroller('gallery-scroller', 'gallery-thumbnails', 'back', 'forward');
                      }

                  }
            },

            destroyScroller : function(){
                var that = this;

                this.$["gallery-scroller"].scroll.destroy();
                this.$["gallery-thumbnails"].scroll.destroy();

                this.$['inline-scroller'].scroll._init();
                this.$['inline-thumbnails'].scroll._init();

                setTimeout(function () {
                        this.$["inline-scroller"].scroll.refresh();
                        this.$["inline-thumbnails"].scroll.refresh();
                        this.$['inline-thumbnails'].fire('click', that.pageToSwap); 
                    }.bind(this), 200);         

                //this.setUpScroller('inline-scroller', 'inline-thumbnails');
            },

            swapImage : function(e) {
                this.set('imgSrc', e.target.src);
            },

            setUpScroller : function(scrollerSelector, thumbnails, back, forward)
            {

                var el = this.$[scrollerSelector],
                  iscroll,  thumbnails, autoScroll, currentPage;

                if(!el)
                  return;
                var that = this;

                if(!el.scroll)
                {
                  setTimeout(function() {
                      that.setUpScroller(scrollerSelector, thumbnails);
                  },
                  1000);
                  return;
                }

                iscroll = el.scroll,
                thumbnails = this.$[thumbnails],
                currentPage = 0;
                iscroll.directionLockThreshold = 20;
                iscroll._init();
                iscroll.directionLockThreshold = 20;

                if(!el || !thumbnails || !thumbnails.childNodes)
                  return;

                var goToPage = function(i) {
                  currentPage = i;

                  if(typeof currentPage == 'undefined')
                    currentPage = iscroll.pages.pageX;

                  iscroll.goToPage(i, 0);
                }

                var selectThumbnail = function(i) {
                  var next = (typeof i != "undefined") ? i : (iscroll.currentPage.pageX || 0);
                  
                  [].forEach.call(thumbnails.getElementsByTagName('iron-image'), function(el) {
                      if(el.classList.contains('selected'))
                      {
                        el.classList.remove('selected');
                        el.parentNode.elevation = 0;
                      }
                  });

                  if(!thumbnails.getElementsByTagName('iron-image')[next])
                    return;
                  
                  thumbnails.getElementsByTagName('iron-image')[next].classList.add('selected');
                  thumbnails.getElementsByTagName('iron-image')[next].parentNode.elevation = 3;

                }

                selectThumbnail(0);

                el.addEventListener('click', function(e) {
                  selectThumbnail();
                  autoScroll = false;
                });
                
                iscroll.on("scrollEnd", function( event ) {
                  selectThumbnail();
                }, false);

                iscroll.on("flick", function() {
                  autoScroll = false;
                });

                thumbnails.addEventListener('click', function(e) {
                  if(e.target.hasAttribute('data-iscroll-page'))
                  {
                    that.pageToSwap = parseInt(e.target.getAttribute('data-iscroll-page'));
                    goToPage(that.pageToSwap);
                    selectThumbnail(that.pageToSwap);
                    autoScroll = false;
                  }
                  else
                  {
                    that.pageToSwap = e.detail;
                    goToPage(that.pageToSwap);
                    selectThumbnail(that.pageToSwap);
                    autoScroll = false;
                  }
                });

                this.$[back].addEventListener('click', function(e) {
                    that.pageToSwap -= 1;
                    if(that.pageToSwap < 0)
                      that.pageToSwap = that.images.length - 1;
                    thumbnails.scroll.prev();
                    goToPage(that.pageToSwap);
                    selectThumbnail(that.pageToSwap);
                    autoScroll = false;
                });

                this.$[forward].addEventListener('click', function(e) {
                    that.pageToSwap += 1;
                    if(that.pageToSwap > (that.images.length - 1))
                      that.pageToSwap = 0;
                    thumbnails.scroll.next();
                    goToPage(that.pageToSwap);
                    selectThumbnail(that.pageToSwap);
                    autoScroll = false;
                });

                if(this.scrollerSetupDone)
                  this.$['gallery'].addEventListener('keydown', function(e) {
                      if(e.keyCode == 37)
                      {
                        that.pageToSwap -= 1;
                        if(that.pageToSwap < 0)
                          that.pageToSwap = that.images.length - 1;
                        thumbnails.scroll.prev();
                        goToPage(that.pageToSwap);
                        selectThumbnail(that.pageToSwap);
                        autoScroll = false;
                      }
                      else
                        if(e.keyCode == 39)
                        {
                          that.pageToSwap += 1;
                          if(that.pageToSwap > (that.images.length - 1))
                            that.pageToSwap = 0;
                          thumbnails.scroll.next();
                          goToPage(that.pageToSwap);
                          selectThumbnail(that.pageToSwap);
                          autoScroll = false;
                        }
                  });

            },

        })
    </script>
</dom-module>